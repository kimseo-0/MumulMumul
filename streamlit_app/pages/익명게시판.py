import streamlit as st
import pandas as pd
from datetime import datetime, timedelta

st.title("💬 익명 게시판 인사이트")

# -----------------------------
# 가짜 데이터 생성
# -----------------------------
today = datetime.now().date()
dates = [today - timedelta(days=i) for i in range(13, -1, -1)]
posts_per_day = [8, 9, 10, 11, 12, 10, 9, 13, 14, 16, 15, 18, 20, 21]

df_daily = pd.DataFrame(
    {"날짜": dates, "게시글 수": posts_per_day}
).set_index("날짜")

category_data = pd.DataFrame(
    {"카테고리": ["고민", "건의", "기타"], "게시글 수": [34, 16, 4]}
).set_index("카테고리")

sentiment_data = pd.DataFrame(
    {"감정": ["positive", "neutral", "negative"], "게시글 수": [12, 28, 14]}
).set_index("감정")

keywords_df = pd.DataFrame(
    {
        "키워드": ["git_conflict", "일정압박", "반 분위기", "리더상담"],
        "언급 횟수": [19, 14, 11, 7],
    }
)

# -----------------------------
# 탭 구성
# -----------------------------
tab_summary, tab_ai, tab_detail = st.tabs(["요약", "AI 심층 분석", "지표 상세 보기"])

# -----------------------------
# 탭 1: 요약
# -----------------------------
with tab_summary:
    st.subheader("요약 지표")

    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("이번 주 익명 게시글 수", "86건", "▲ 12건")
    with col2:
        st.metric("고민 글 비율", "63%", "▲ 15%p")
    with col3:
        st.metric("Negative 감정 비율", "31%", "▲ 9%p")
    with col4:
        st.metric("새 이슈 키워드 수", "4개")

    st.markdown(
        """
- 이번 주에는 **Git 협업**과 **프로젝트 일정 압박** 관련 고민이 두드러집니다.  
- 전체 글 수는 비슷하지만, **고민·부정 감정 비율**이 지난주 대비 눈에 띄게 상승했습니다.  
- 일부 반에서는 “뒤처지는 느낌”, “말 꺼내기 어려움”과 같은 표현이 반복적으로 등장합니다.
"""
    )

    st.markdown("### 분위기 흐름 간단 보기")
    st.line_chart(df_daily)

# -----------------------------
# 탭 2: AI 심층 분석
# -----------------------------
with tab_ai:
    st.subheader("AI 분석 요약")

    st.markdown(
        """
- **핵심 이슈**
  - Git 충돌, 브랜치 꼬임, merge 에러 등 **협업 과정에서의 실수와 실패 경험**이 많이 언급됩니다.
  - “시간이 부족하다”, “일정이 너무 빠르다”는 식의 **속도·압박감**이 반복적으로 나타납니다.

- **분위기 변화**
  - 고민 비율이 48% → **63%**로 상승했습니다.
  - negative 감정 게시글 비율도 22% → **31%**로 증가했습니다.
  - 단순 불평보다는 “도움을 요청”하는 성격의 글이 많아, **지원에 대한 기대**가 함께 읽힙니다.

- **운영 관점 해석**
  - 현재 커리큘럼 구간은 “실패를 통해 배우는” 영역인데, 실패 경험이 **반복·장기화**되면서 부담으로 바뀌고 있습니다.
  - Git · 일정 · 반 내 커뮤니케이션 문제가 겹치며, 일부 반/학습자에게는 **이탈 위험 신호**로 이어질 수 있습니다.
"""
    )

    with st.expander("분석 근거 자세히 보기"):
        st.markdown(
            """
- Git 관련 키워드 언급: 7건 → **19건**  
- '일정', '시간 부족' 관련 표현: 5건 → **13건**  
- 고민 비율: 48% → **63%**  
- negative 감정 게시글: 9건 → **14건**  

예시 문장:

- “git conflict 때문에 하루를 통째로 날렸어요. 반 친구들한테 너무 미안하네요.”
- “진도가 빠르게 밀려서, 복습할 시간이 거의 없습니다.”
- “자꾸만 뒤처지는 느낌이라, 반 분위기 흐릴까 봐 말 꺼내기가 어렵네요.”
"""
        )

    st.subheader("운영 액션 제안")

    st.markdown(
        """
- **Git 부담 완화**
  - 각 반에서 자주 등장하는 Git 에러 유형을 모아, **간단한 해결 가이드**를 배포합니다.
  - 1회에 한해, **Git conflict 실습만을 위한 짧은 세션**을 여는 것을 추천합니다.

- **일정·속도 조정**
  - 이번 주 과제 마감일을 1일 유예하거나, 난이도가 높은 선택 과제를 한시적으로 제외할 수 있습니다.
  - “이 구간은 원래 어렵고, 지금 느끼는 어려움이 비정상이 아니다”는 메시지를 함께 전달하면 부담을 줄일 수 있습니다.

- **반 단위 케어**
  - 고민 글이 많이 올라오는 반(예: 베타반, 감마반)을 중심으로,  
    반 담당 멘토가 **짧은 체크인 시간(5~10분)**을 가져 현 상태를 가볍게 물어보는 것을 추천합니다.
"""
    )

# -----------------------------
# 탭 3: 지표 상세 보기
# -----------------------------
with tab_detail:
    st.subheader("게시글 흐름")

    st.markdown("**일별 익명 게시글 수**")
    st.line_chart(df_daily)

    st.markdown("**카테고리별 게시글 분포 (최근 7일)**")
    st.bar_chart(category_data)

    st.markdown("**감정 분포 (최근 7일)**")
    st.bar_chart(sentiment_data)

    st.markdown("**상위 키워드**")
    st.table(keywords_df)
