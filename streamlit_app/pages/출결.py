import streamlit as st
import pandas as pd
import altair as alt
from datetime import date, timedelta

st.set_page_config(layout="wide")

# --------------------------------
# 사이드바: 반 선택 / 기간 / 주차
# --------------------------------
st.sidebar.header("캠프 설정")

today = date.today()
class_options = ["전체", "1반", "2반", "3반", "4반"]
selected_class = st.sidebar.selectbox("반 선택", class_options, index=0)

start_date = st.sidebar.date_input("반 시작일", value=today - timedelta(weeks=2))
end_date = st.sidebar.date_input("반 종료일", value=today + timedelta(weeks=4))

if start_date > end_date:
    st.sidebar.error("반 시작일이 종료일 이후임. 날짜를 다시 선택해야 함.")

if today < start_date:
    week_label = "개강 전"
elif today > end_date:
    week_label = "수료 이후"
else:
    delta_days = (today - start_date).days
    week_num = delta_days // 7 + 1
    week_label = f"{week_num}주차"

st.sidebar.markdown(f"**현재 주차:** {week_label}")

# --------------------------------
# 반별 분위기 차이를 위한 factor 설정 (더미)
# --------------------------------
# 1반: 전반적으로 건강한 참여
# 2반: 출석·참여 모두 낮은 문제 반
# 3반: 출석은 높지만 형식적 참여가 많은 반
# 4반: 회복 중인 혼합 반
factor_map = {
    "전체": 1.0,
    "1반": 1.05,
    "2반": 0.75,
    "3반": 1.0,
    "4반": 0.9,
}
factor = factor_map[selected_class]

title_suffix = "전체 반 기준" if selected_class == "전체" else f"{selected_class} 기준"
st.title(f"🧍 출결 & 이탈 위험 모니터링 리포트 ({title_suffix})")

# --------------------------------
# BASE DATA (전체 기준) - 반별 5명씩, 총 20명 + 성향 설문
# --------------------------------
weeks = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6"]
attendance_rate_base = [88, 86, 84, 83, 80, 82]
df_att_base = pd.DataFrame({"주차": weeks, "출석률": attendance_rate_base})

df_users_base = pd.DataFrame(
    [
        # 1반: 전반적으로 건강한 참여, 1명만 주의
        {
            "이름": "김지훈", "반": "1반",
            "최근 7일 접속일수": 7, "최근 7일 접속시간(분)": 560,
            "최근 7일 회의 참석 횟수": 5, "최근 7일 챗봇 질문 수": 8,
            "리스크 상태": "정상", "패턴": "안정적 고참여형",
            "학습 성향": "자기주도형", "팀 참여 성향": "리더형",
            "추천 액션": "핵심 참여자로 인정·피드백 제공함. 동기 유지 차원의 긍정 피드백이 유효함.",
        },
        {
            "이름": "박소현", "반": "1반",
            "최근 7일 접속일수": 6, "최근 7일 접속시간(분)": 420,
            "최근 7일 회의 참석 횟수": 4, "최근 7일 챗봇 질문 수": 6,
            "리스크 상태": "정상", "패턴": "안정적 참여형",
            "학습 성향": "실습선호형", "팀 참여 성향": "중재자형",
            "추천 액션": "현재 패턴을 유지할 수 있도록 작은 성취 피드백을 주는 것이 좋음.",
        },
        {
            "이름": "정민우", "반": "1반",
            "최근 7일 접속일수": 5, "최근 7일 접속시간(분)": 360,
            "최근 7일 회의 참석 횟수": 3, "최근 7일 챗봇 질문 수": 4,
            "리스크 상태": "정상", "패턴": "보통 수준 참여형",
            "학습 성향": "구조필요형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "체크리스트·정리 노트를 제공하면 이해도와 참여도가 함께 올라갈 가능성이 있음.",
        },
        {
            "이름": "이다영", "반": "1반",
            "최근 7일 접속일수": 4, "최근 7일 접속시간(분)": 260,
            "최근 7일 회의 참석 횟수": 2, "최근 7일 챗봇 질문 수": 2,
            "리스크 상태": "주의", "패턴": "참여 서서히 감소형",
            "학습 성향": "구조필요형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "이해가 안 되는 부분을 혼자 끙끙대는 경향이 있을 수 있어, 1:1 질문 채널을 먼저 안내하는 것이 좋음.",
        },
        {
            "이름": "한유진", "반": "1반",
            "최근 7일 접속일수": 5, "최근 7일 접속시간(분)": 300,
            "최근 7일 회의 참석 횟수": 3, "최근 7일 챗봇 질문 수": 3,
            "리스크 상태": "정상", "패턴": "안정적 참여형",
            "학습 성향": "이론선호형", "팀 참여 성향": "중재자형",
            "추천 액션": "개념 정리·요약을 맡기는 등, 강점을 살릴 수 있는 역할을 소규모로 부여하면 좋음.",
        },

        # 2반: 출석·참여 모두 낮은 문제 반 (고위험/주의 다수)
        {
            "이름": "이서연", "반": "2반",
            "최근 7일 접속일수": 2, "최근 7일 접속시간(분)": 80,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "고위험", "패턴": "고활동→급감 의심형",
            "학습 성향": "실습선호형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "실습 위주로 다시 시작할 수 있는 작은 과제를 제안하고, 1:1로 진행 상황을 함께 점검하는 것이 필요함.",
        },
        {
            "이름": "박민수", "반": "2반",
            "최근 7일 접속일수": 3, "최근 7일 접속시간(분)": 120,
            "최근 7일 회의 참석 횟수": 1, "최근 7일 챗봇 질문 수": 2,
            "리스크 상태": "주의", "패턴": "저활동-지속형",
            "학습 성향": "이론선호형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "이론·개념 정리 자료를 먼저 제공하고, 팀 활동보다는 개인 과제를 통해 동기를 회복하도록 돕는 것이 좋음.",
        },
        {
            "이름": "최현우", "반": "2반",
            "최근 7일 접속일수": 1, "최근 7일 접속시간(분)": 40,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "고위험", "패턴": "거의 이탈 상태",
            "학습 성향": "구조필요형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "학습 계획·우선순위를 함께 다시 짜주는 것이 우선이며, 당장 필요한 최소 목표를 함께 정의해야 함.",
        },
        {
            "이름": "장예린", "반": "2반",
            "최근 7일 접속일수": 2, "최근 7일 접속시간(분)": 60,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "고위험", "패턴": "조용한 이탈형",
            "학습 성향": "자기주도형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "스스로 알아서 해야 한다는 압박이 있을 수 있어, 도움이 필요할 때 요청해도 괜찮다는 메시지를 먼저 전하는 것이 중요함.",
        },
        {
            "이름": "윤지호", "반": "2반",
            "최근 7일 접속일수": 3, "최근 7일 접속시간(분)": 100,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "주의", "패턴": "형식적 접속형",
            "학습 성향": "이론선호형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "발언보다 텍스트 기반 질의응답이 편할 수 있으므로, 익명 질문·챗봇 활용법을 다시 안내하는 것이 좋음.",
        },

        # 3반: 출석은 높지만 형식적 참여가 많은 반
        {
            "이름": "최유진", "반": "3반",
            "최근 7일 접속일수": 7, "최근 7일 접속시간(분)": 500,
            "최근 7일 회의 참석 횟수": 4, "최근 7일 챗봇 질문 수": 5,
            "리스크 상태": "정상", "패턴": "핵심 참여자형",
            "학습 성향": "자기주도형", "팀 참여 성향": "리더형",
            "추천 액션": "다른 조원들에게 질문을 받아주는 역할을 부탁하면, 반 전체의 참여 분위기를 끌어올리는 데 도움이 됨.",
        },
        {
            "이름": "오지훈", "반": "3반",
            "최근 7일 접속일수": 7, "최근 7일 접속시간(분)": 300,
            "최근 7일 회의 참석 횟수": 1, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "주의", "패턴": "형식적 출석형",
            "학습 성향": "실습선호형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "조별 실습에서 작은 역할(예: 특정 기능 구현)을 맡기고, 결과만 공유하도록 하면 부담을 줄이면서 참여를 유도할 수 있음.",
        },
        {
            "이름": "김민지", "반": "3반",
            "최근 7일 접속일수": 7, "최근 7일 접속시간(분)": 280,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "주의", "패턴": "조용한 관찰자형",
            "학습 성향": "이론선호형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "발언 대신 채팅·노션 코멘트로 의견을 남길 수 있는 구조를 안내하면, 안전하게 참여를 시작할 수 있음.",
        },
        {
            "이름": "정하늘", "반": "3반",
            "최근 7일 접속일수": 6, "최근 7일 접속시간(분)": 260,
            "최근 7일 회의 참석 횟수": 1, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "정상", "패턴": "보통 참여형",
            "학습 성향": "구조필요형", "팀 참여 성향": "중재자형",
            "추천 액션": "특정 세션에서 토론 정리·발표를 맡기는 등, 중재·정리 역할을 시도해 볼 수 있음.",
        },
        {
            "이름": "이도윤", "반": "3반",
            "최근 7일 접속일수": 6, "최근 7일 접속시간(분)": 240,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "주의", "패턴": "조용한 형식 참여형",
            "학습 성향": "실습선호형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "1:1 코드 리뷰나 짝 프로그래밍처럼, 소규모·쌍방향 실습 구조를 먼저 제안하는 것이 좋음.",
        },

        # 4반: 혼합/회복 중인 반
        {
            "이름": "정우성", "반": "4반",
            "최근 7일 접속일수": 5, "최근 7일 접속시간(분)": 320,
            "최근 7일 회의 참석 횟수": 3, "최근 7일 챗봇 질문 수": 2,
            "리스크 상태": "정상", "패턴": "안정적 참여형",
            "학습 성향": "실습선호형", "팀 참여 성향": "리더형",
            "추천 액션": "다른 학습자들의 실습을 도와주는 역할을 가볍게 제안해 볼 수 있음.",
        },
        {
            "이름": "송지윤", "반": "4반",
            "최근 7일 접속일수": 4, "최근 7일 접속시간(분)": 220,
            "최근 7일 회의 참석 횟수": 2, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "정상", "패턴": "보통 참여형",
            "학습 성향": "이론선호형", "팀 참여 성향": "중재자형",
            "추천 액션": "개념 정리를 도와주는 역할·노트 공유 등을 한 번 요청해보면 자기 효능감 향상에 도움이 됨.",
        },
        {
            "이름": "백승호", "반": "4반",
            "최근 7일 접속일수": 3, "최근 7일 접속시간(분)": 150,
            "최근 7일 회의 참석 횟수": 1, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "주의", "패턴": "저활동-지속형",
            "학습 성향": "구조필요형", "팀 참여 성향": "개별작업선호형",
            "추천 액션": "주간 목표·진행 체크리스트를 공유하고, 한 번만 따라와도 괜찮다는 메시지를 함께 전달하는 것이 필요함.",
        },
        {
            "이름": "이지연", "반": "4반",
            "최근 7일 접속일수": 4, "최근 7일 접속시간(분)": 180,
            "최근 7일 회의 참석 횟수": 1, "최근 7일 챗봇 질문 수": 1,
            "리스크 상태": "주의", "패턴": "참여 회복 중",
            "학습 성향": "실습선호형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "최근 참여가 늘어난 점을 구체적으로 칭찬해주고, 실습 위주의 작은 과제를 추가로 제안하는 것이 좋음.",
        },
        {
            "이름": "김나영", "반": "4반",
            "최근 7일 접속일수": 2, "최근 7일 접속시간(분)": 90,
            "최근 7일 회의 참석 횟수": 0, "최근 7일 챗봇 질문 수": 0,
            "리스크 상태": "고위험", "패턴": "이탈 직전형",
            "학습 성향": "구조필요형", "팀 참여 성향": "조용한관찰자형",
            "추천 액션": "진행이 힘든 이유(시간·난이도·심리)를 먼저 듣고, 주당 최소 목표를 다시 합의하는 과정이 필요함.",
        },
    ]
)

# --------------------------------
# 반 선택 시 필터링 + 출석률 factor 적용
# --------------------------------
if selected_class == "전체":
    df_users = df_users_base.copy()
else:
    df_users = df_users_base[df_users_base["반"] == selected_class].copy()

df_att = df_att_base.copy()
df_att["출석률"] = (df_att["출석률"] * factor).clip(50, 100).round(1)

# 위험 학습자 정렬 및 요약
df_risk_sorted = df_users[df_users["리스크 상태"] != "정상"].sort_values(
    by=["리스크 상태", "최근 7일 접속일수"]
)
top_risk_users = df_risk_sorted.head(3)

avg_attendance = int(df_att["출석률"].mean())
risky_count = (df_users["리스크 상태"] == "고위험").sum()
warning_count = (df_users["리스크 상태"] == "주의").sum()
low_access_count = (df_users["최근 7일 접속일수"] <= 2).sum()

# 성향 분포 집계 (선택된 반 기준)
df_style_learning = (
    df_users.groupby("학습 성향")
    .size()
    .reset_index(name="인원수")
)
df_style_team = (
    df_users.groupby("팀 참여 성향")
    .size()
    .reset_index(name="인원수")
)

# --------------------------------
# 탭 구성
# --------------------------------
tab_summary, tab_ai = st.tabs(["요약", "AI 심층 분석"])

# --------------------------------
# (1) 요약 탭
# --------------------------------
with tab_summary:
    st.subheader(f"{week_label} 요약 - {title_suffix}")

    col1, col2, col3, col4 = st.columns(4)
    col1.metric("평균 출석률", f"{avg_attendance}%", f"{avg_attendance-82:+}p")
    col2.metric("3일 이하 접속자 수", f"{low_access_count}명")
    col3.metric("고위험 학습자 수", f"{risky_count}명")
    col4.metric("주의 학습자 수", f"{warning_count}명")

    st.markdown("### 이번 주 출결·참여 요약")
    st.info(
        f"""
이번 주 {title_suffix} 출석률은 평균 **{avg_attendance}%** 수준임.  
다만, **초반 대비 최근 1주일 간 활동량이 눈에 띄게 줄어든 학습자**와  
**접속은 유지하지만 실제 참여가 거의 없는 학습자**가 함께 존재함.
"""
    )

    st.markdown("---")
    st.markdown("### 출석 지표 한눈에 보기")

    st.markdown("#### 주차별 출석률 추이")
    chart_att = (
        alt.Chart(df_att)
        .mark_line(point=True)
        .encode(
            x="주차:N",
            y="출석률:Q",
            tooltip=["주차", "출석률"],
        )
        .properties(height=260)
    )
    st.altair_chart(chart_att, use_container_width=True)
    st.caption("주차별 평균 출석률 추이임.")

    st.markdown("#### 위험 학습자 상위 3명")

    if not top_risk_users.empty:
        st.table(
            top_risk_users[
                ["이름", "반", "최근 7일 접속일수", "리스크 상태"]
            ].set_index("이름")
        )
    else:
        st.write("해당 반에는 고위험/주의 학습자가 없음.")

    st.markdown("#### 학습자 상세 리스트")

    risk_filter = st.multiselect(
        "리스크 상태 필터",
        ["정상", "주의", "고위험"],
        default=["주의", "고위험"],
    )
    df_view = df_users[df_users["리스크 상태"].isin(risk_filter)]
    st.dataframe(df_view, use_container_width=True)

# --------------------------------
# (2) AI 심층 분석 탭
# --------------------------------
with tab_ai:
    st.subheader(f"AI 인사이트 분석 - {title_suffix}")

    # 반별 분위기 한줄 요약
    if selected_class == "전체":
        반_한줄 = "반마다 출결·참여 패턴이 상이함."
    elif selected_class == "1반":
        반_한줄 = "전반적으로 안정적이고 건강한 참여 패턴이 나타나는 반임."
    elif selected_class == "2반":
        반_한줄 = "출석률과 참여도가 전반적으로 낮고, 이탈 위험이 높은 반임."
    elif selected_class == "3반":
        반_한줄 = "출석률은 높으나, 소수 인원 중심의 형식적 참여 패턴이 나타나는 반임."
    else:  # 4반
        반_한줄 = "참여 수준이 들쭉날쭉하지만, 일부 학습자는 회복 흐름을 보이는 반임."

        
    colA, colB, colC = st.columns(3)
    colA.info(
        f"**출석·참여 패턴 요약**\n\n"
        f"- 평균 출석률: 약 {avg_attendance}% 수준임\n"
        f"- {반_한줄}"
    )
    colB.warning(
        "**주의 신호 요약**\n\n"
        f"- 3일 이하 접속 학습자 {low_access_count}명 존재함\n"
        f"- 고위험 학습자 {risky_count}명, 주의 학습자 {warning_count}명 확인됨"
    )
    colC.success(
        "**운영 우선 과제**\n\n"
        "- 고위험·주의 학습자 1:1 케어 필요함\n"
        "- 반별 참여 구조 점검 및 역할 재배분 검토 필요함"
    )

    st.markdown("---")


    # 0. 성향 분포 분석
    st.markdown("### 0. 학습/팀 성향 분포 분석")

    col_style1, col_style2 = st.columns(2)

    with col_style1:
        st.markdown("#### 0-1. 학습 성향 분포")
        chart_learn = (
            alt.Chart(df_style_learning)
            .mark_bar()
            .encode(
                x=alt.X("인원수:Q", title="인원수"),
                y=alt.Y("학습 성향:N", sort="-x", title="학습 성향"),
                color=alt.Color("학습 성향:N", legend=None),
                tooltip=["학습 성향", "인원수"],
            )
            .properties(height=220)
        )
        st.altair_chart(chart_learn, use_container_width=True)
        st.caption("이 반에서 어떤 학습 성향이 많은지 한눈에 볼 수 있음.")

    with col_style2:
        st.markdown("#### 0-2. 팀 참여 성향 분포")
        chart_team = (
            alt.Chart(df_style_team)
            .mark_bar()
            .encode(
                x=alt.X("인원수:Q", title="인원수"),
                y=alt.Y("팀 참여 성향:N", sort="-x", title="팀 참여 성향"),
                color=alt.Color("팀 참여 성향:N", legend=None),
                tooltip=["팀 참여 성향", "인원수"],
            )
            .properties(height=220)
        )
        st.altair_chart(chart_team, use_container_width=True)
        st.caption("이 반에서 팀 활동 시 어떤 역할/태도가 많은지 확인 가능함.")

    st.markdown("---")

    # 1. 출석률 분석
    st.markdown("### 1. 출석률 및 참여 경향 분석")

    left, right = st.columns([1.3, 1.2])

    with left:
        st.markdown("#### 1-1. 출석률 경향 요약")
        st.markdown(
            f"""
- 최근 출석률은 평균 **{avg_attendance}%** 수준으로 유지되고 있음.  
- 다만, 일부 주차 이후로 **일부 학습자의 접속일수·참여도가 점진적으로 감소하는 신호**가 관찰됨.  
- 특히 고위험/주의 학습자가 많은 반일수록, 출석률 하락과 함께 **심리적 거리 증가** 가능성이 높음.
"""
        )

    with right:
        st.markdown("#### 1-2. 출석률 추이 그래프")
        st.altair_chart(chart_att, use_container_width=True)
        st.caption("주차별 출석률 변동을 통해 특정 구간 이후 이탈 신호를 확인할 수 있음.")

    st.markdown("---")

    # 2. 위험 학습자 패턴 분석
    st.markdown("### 2. 위험 학습자 패턴 분석")

    colX, colY = st.columns([1.4, 1.0])

    with colX:
        st.markdown("#### 2-1. 대표 패턴 요약")
        st.markdown(
            """
- **고활동 → 급감형**
  - 초반에는 적극적으로 참여했으나, 최근 1~2주 사이 접속·회의 참석이 급감한 유형임.
  - 과부하, 번아웃, 일정 충돌 등으로 인한 급격한 동기 저하가 의심됨.

- **형식적 출석형**
  - 접속은 유지되지만, 회의 발언·질문·캠프 체류가 거의 없는 유형임.
  - 뒤처지고 있다고 느끼지만, 드러나는 것이 부담스러워 **조용히 버티는 상태**일 수 있음.

- **저활동-지속형**
  - 처음부터 전체적으로 낮은 참여를 유지하는 유형임.
  - 과정의 목표와 개인의 목표가 충분히 연결되지 않았을 가능성이 높음.
"""
        )

    with colY:
        st.markdown("#### 2-2. 위험 학습자 상위 3명")
        if not top_risk_users.empty:
            st.table(
                top_risk_users[
                    ["이름", "반", "최근 7일 접속일수", "리스크 상태"]
                ].set_index("이름")
            )
        else:
            st.write("해당 반에는 현재 고위험/주의 학습자가 없음.")

    st.markdown("---")

    # 3. 위험 학습자 개별 액션 제안 (성향 포함)
    st.markdown("### 3. 위험 학습자 개별 액션 제안")

    st.markdown(
        """
아래 표는 **리스크 상태가 '주의' 또는 '고위험'인 학습자**를 대상으로,  
각 학습자의 출결 패턴과 **설문 기반 성향**을 함께 반영하여  
개별 대응 방향을 요약한 것임.
"""
    )

    df_risky_actions = df_users[df_users["리스크 상태"] != "정상"].copy()

    if not df_risky_actions.empty:
        st.table(
            df_risky_actions[
                [
                    "이름",
                    "반",
                    "리스크 상태",
                    "학습 성향",
                    "팀 참여 성향",
                    "패턴",
                    "추천 액션",
                ]
            ].set_index("이름")
        )
    else:
        st.info("현재 선택된 반에는 별도의 개별 액션이 필요한 위험 학습자가 없음.")

    st.markdown(
        """
- **고위험 학습자**
  - 우선 순위로 1:1 안부 확인이 필요함.  
  - 학습 난이도 문제가 아니라면, 일정·생활·심리적 부담 등 다른 요소를 함께 점검해야 함.

- **주의 학습자**
  - 이탈까지 이어지지 않도록, 비교적 가벼운 방식으로 상태를 확인하는 것이 좋음.  
  - "요즘 페이스는 어떤지", "어디가 가장 막히는지"를 묻는 수준에서 시작함.
"""
    )

    st.markdown("---")

    # 4. 반별 운영 액션 정리
    st.markdown("### 4. 반별 운영 액션 정리")

    colP, colQ = st.columns(2)

    with colP:
        st.markdown("#### 4-1. 단기(1~2주) 액션")
        if selected_class == "2반":
            st.markdown(
                """
- 2반의 경우, **고위험 학습자가 다수 존재**하므로  
  우선 순위 3명을 선정해 1:1 메시지를 발송해야 함.  
- 회의·캠프 참여 문턱을 낮추기 위해, 카메라 OFF/음성·채팅 기반 참여도 허용하는 등  
  **참여 방식의 유연성**을 높여야 함.
"""
            )
        elif selected_class == "1반":
            st.markdown(
                """
- 1반은 전반적으로 안정적이므로, 현재 좋은 흐름을 유지하는 것이 중요함.  
- 핵심 참여자에게 과도한 역할이 쏠리지 않도록, 작은 역할을 고르게 분배하는 것이 좋음.
"""
            )
        elif selected_class == "3반":
            st.markdown(
                """
- 3반은 출석률이 높지만 형식적 참여가 많음.  
- 소규모 조별 토론, 라운드형 발표 등 **말할 수밖에 없는 구조**를 일부 세션에 도입하는 것이 필요함.
"""
            )
        elif selected_class == "4반":
            st.markdown(
                """
- 4반은 회복 중인 학습자와 여전히 위험 상태인 학습자가 함께 존재함.  
- 최근 참여가 늘어난 학습자에게는 구체적 칭찬을 제공해 긍정적 강화가 필요함.
"""
            )
        else:
            st.markdown(
                """
- 고위험·주의 학습자 리스트를 기준으로,  
  **각 반에서 최소 1~2명씩 우선 케어 대상**을 지정해야 함.  
- 이들에게는 안부와 부담 완화를 중심으로 한 메시지를 먼저 보내는 것이 좋음.
"""
            )

    with colQ:
        st.markdown("#### 4-2. 중기(3주 이상) 액션")
        st.markdown(
            """
- 출결·참여 데이터와 익명 게시판, 질문 로그를 연계해  
  **특정 주차 이후에 반복적으로 이탈 신호가 발생하는지** 확인해야 함.  
- 이탈 신호가 반복되는 구간은 **커리큘럼 난이도·과제량·일정**을 재조정하는 것이 바람직함.  
- 반별로 2주~4주 간격의 **정기 상태 점검 미팅**(리더·멘토 동반)을 운영하는 체계를 마련하는 것이 좋음.
"""
        )

    st.caption("※ 현재 화면은 더미 데이터를 기반으로 한 예시이며, 실제 서비스에서는 실시간 출결·참여 로그와 설문 결과, LLM 분석을 기반으로 자동 생성됨.")
