import streamlit as st
import pandas as pd

st.title("🧍 출결 & 이탈 위험 모니터링")

# -----------------------------
# 가짜 데이터 생성
# -----------------------------
weeks = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6"]
attendance_rate = [88, 86, 84, 83, 80, 82]

df_attendance = pd.DataFrame(
    {"주차": weeks, "출석률": attendance_rate}
).set_index("주차")

classes = ["1반", "2반", "3반", "4반"]
class_attendance = [86, 79, 81, 83]
df_class = pd.DataFrame(
    {"반": classes, "출석률": class_attendance}
).set_index("반")

df_users = pd.DataFrame(
    {
        "이름": ["김지훈", "이서연", "박민수", "최유진", "정우성"],
        "반": ["1반", "2반", "2반", "3반", "4반"],
        "최근 7일 접속일수": [6, 2, 7, 3, 5],
        "최근 7일 접속시간(분)": [540, 80, 610, 150, 320],
        "최근 7일 회의 참석 횟수": [5, 0, 4, 1, 3],
        "최근 7일 캠프(반 공간) 체류시간(분)": [220, 0, 180, 40, 130],
        "최근 7일 챗봇 질문 수": [9, 1, 12, 3, 2],
        "리스크 상태": ["정상", "고위험", "정상", "주의", "주의"],
    }
)

# -----------------------------
# 탭 구성
# -----------------------------
tab_summary, tab_ai, tab_detail = st.tabs(["요약", "AI 심층 분석", "지표 상세 보기"])

# -----------------------------
# 탭 1: 요약
# -----------------------------
with tab_summary:
    st.subheader("요약 지표")

    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("전체 평균 출석률", "82%", "-3%p")
    with col2:
        st.metric("3일 이상 연속 미접속 인원", "5명")
    with col3:
        st.metric("참여 급감 인원", "4명")
    with col4:
        st.metric("고위험 학습자", "3명")

    st.markdown(
        """
- 전체 출석률은 큰 폭의 감소 없이 유지되고 있습니다.  
- 다만, 초반에는 적극적으로 참여하다가 최근 1주일간 **접속과 참여가 급감한 학습자**가 몇 명 포착됩니다.  
- 일부 반에서는 “형식적인 출석”만 유지되고, 실제 상호작용은 거의 없는 패턴이 보입니다.
"""
    )

    st.markdown("### 주차별 출석 흐름")
    st.line_chart(df_attendance)

# -----------------------------
# 탭 2: AI 심층 분석
# -----------------------------
with tab_ai:
    st.subheader("AI 분석 요약")

    st.markdown(
        """
- **초반 고활동 → 최근 급감 패턴**
  - 예: `이서연(2반)`, `최유진(3반)`  
  - 초반 2주간은 반 평균보다 높은 출석·참여를 보였지만, 최근 7일 동안 접속일수·회의 참여·캠프 체류시간이 모두 크게 감소했습니다.

- **형식적 출석 패턴**
  - 출석 체크는 유지되지만, 회의 참여나 반 공간 체류시간, 챗봇 질문이 거의 없는 학습자가 일부 존재합니다.
  - 특히 **2반**에서 이 패턴이 두드러지며, 반 분위기와 소속감 문제로 연결될 여지가 있습니다.

- **반 단위 관점**
  - 2반의 평균 출석률은 79%로, 전체 평균(82%)보다 낮습니다.
  - 출석률은 비슷하지만 참여 편차가 큰 반(예: 3반)은, 일부 핵심 인원에게만 부담이 집중될 수 있습니다.
"""
    )

    with st.expander("분석 근거 자세히 보기"):
        st.markdown(
            """
- 이서연(2반)
  - Week 1~2:
    - 주 6일 접속, 주간 총 접속시간 480분 이상
    - 회의 참석 4회, 반 공간 체류 160분
  - 최근 7일:
    - 접속일수 2일, 총 접속시간 80분
    - 회의·반 공간 체류 모두 0회·0분

- 2반
  - 반 평균 출석률: **79%** (전체 82% 대비 낮음)
  - 반 공간 체류시간과 회의 참석률도 다른 반 대비 낮은 수준

- 3반
  - 출석률은 81%로 평균 수준이지만,  
  - 회의와 반 공간에서 활발히 참여하는 인원이 소수에 치우치는 패턴
"""
        )

    st.subheader("운영 액션 제안")

    st.markdown(
        """
- **고위험 학습자 1:1 케어**
  - 최근 참여가 급감한 학습자에게는 **안부와 부담 완화에 초점을 둔 메시지**를 보내는 것이 좋습니다.
  - 예시:
    > “요즘 컨디션은 괜찮으신가요?  
    > 최근에 접속이 잠깐 줄어든 것 같아서, 혹시 도움이 필요한 부분이 있는지 조심스럽게 여쭤보고 싶었어요.  
    > 편하게 말씀해 주시면 함께 방법을 고민해보고 싶어요.”

- **반 단위 개입**
  - 2반처럼 출석과 참여 모두 낮은 반은, 담당 멘토와 먼저 상황을 공유한 뒤  
    - 수업 전후로 **짧은 체크인 라운드(오늘 가장 막힌 부분 한 가지씩 나누기)**를 도입해 보는 것을 추천합니다.
  - 3반처럼 참여 편차가 큰 반은, 특정 인원에게만 일이 몰리지 않도록 역할 배분을 재점검할 필요가 있습니다.

- **캠프 전체 메시지**
  - “잠깐 리듬이 깨지는 시기가 있을 수 있다”는 점을 인정해 주고,  
    - 이번 주는 “출석 3일만 지키기”처럼 **작은 목표**를 제안하는 방식으로 다시 리듬을 만들어 줄 수 있습니다.
"""
    )

# -----------------------------
# 탭 3: 지표 상세
# -----------------------------
with tab_detail:
    st.subheader("주차별 전체 출석률")
    st.line_chart(df_attendance)

    st.subheader("반별 평균 출석률")
    st.bar_chart(df_class)

    st.subheader("학습자별 참여 현황")
    st.dataframe(df_users, width='stretch')
